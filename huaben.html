<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>画本模块 · 有声小手机</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg:#0b0d12; --panel:#111623; --panel2:#0e1422; --line:#1f2431; --line2:#28324a; --text:#e8ecf1; --muted:#9aa4b2;
      --blue:#375dfc; --green:#10b981; --amber:#f59e0b; --pink:#ec4899; --gray:#6b7280;
      --role-narr:#2b3347; --role-a:#253856; --role-b:#283a2f; --role-c:#3a2b3a; --role-d:#3b2f24;
    }
    *{ box-sizing: border-box; }
    body{ margin:0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; color:var(--text); background:var(--bg); }
    header{ position:sticky; top:0; z-index:5; background:rgba(11,13,18,.8); backdrop-filter: blur(6px); border-bottom:1px solid var(--line); }
    .bar{ max-width: 1280px; margin:0 auto; padding:12px 16px; display:flex; gap:12px; align-items:center; }
    .btn{ background:var(--panel2); border:1px solid var(--line); color:var(--text); padding:8px 12px; border-radius:10px; cursor:pointer; }
    .btn:hover{ border-color:#3851ff66; }
    .ghost{ background:transparent; }
    .right{ margin-left:auto; display:flex; gap:8px; align-items:center; }
    .muted{ color:var(--muted); font-size:12px; }
    .file{ color:var(--muted); }
    .wrap{ max-width:1280px; margin:0 auto; padding:16px; display:grid; grid-template-columns: 260px 1fr; gap:16px; }
    aside{ background:var(--panel); border:1px solid var(--line); border-radius:14px; padding:12px; }
    main{ background:var(--panel); border:1px solid var(--line); border-radius:14px; padding:0; overflow:hidden; }
    h2{ margin:0 0 8px; font-size:16px; }
    table{ width:100%; border-collapse: collapse; }
    th, td{ border-bottom:1px solid var(--line2); padding:10px; font-size:14px; vertical-align: top; }
    th{ position:sticky; top:0; background:var(--panel2); z-index:2; }
    .rownum{ width:56px; text-align:right; color:var(--muted); }
    .speaker{ width:120px; }
    .text{ width:auto; }
    .cell-ops{ width:360px; }
    .pill{ display:inline-block; padding:4px 8px; border-radius:999px; border:1px solid var(--line2); color:var(--muted); font-size:12px; }
    .small{ font-size:12px; color:var(--muted); }
    .rolelist{ width:100%; border-collapse: collapse; }
    .rolelist th, .rolelist td{ border-bottom:1px dashed var(--line2); padding:8px 6px; font-size:13px; }
    .hint{ margin-top:8px; font-size:12px; color:var(--muted); }
    input[type="number"], select{ background:#0e1320; color:var(--text); border:1px solid var(--line2); border-radius:8px; padding:6px 8px; }
    input[type="text"]{ width:100%; background:#0e1320; color:var(--text); border:1px solid var(--line2); border-radius:8px; padding:6px 8px; }
    textarea{ width:100%; min-height:120px; background:#0e1320; color:var(--text); border:1px solid var(--line2); border-radius:10px; padding:8px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .color-narr{ background: var(--role-narr); }
    .color-a{ background: var(--role-a); }
    .color-b{ background: var(--role-b); }
    .color-c{ background: var(--role-c); }
    .color-d{ background: var(--role-d); }
    .toolbar { padding:12px; border-bottom:1px solid var(--line2); display:flex; gap:8px; align-items:center; }
    .grow { flex:1; }
    .stat { color:var(--muted); font-size:12px; }
    a.link { color:#9ec1ff; text-decoration:none; }
    a.link:hover{ text-decoration:underline; }
  </style>
</head>
<body>
  <header>
    <div class="bar">
      <a class="btn ghost" href="./index.html">← 返回首页</a>
      <strong>画本模块</strong>
      <span class="muted">上传纯文本，自动生成「旁白/角色台词」结构</span>
      <div class="right">
        <label class="btn">
          选择文本… <input id="fileInput" type="file" accept=".txt,.md,.rtf" style="display:none;">
        </label>
        <button class="btn" id="parseBtn">自动画本</button>
        <button class="btn" id="saveJsonBtn">导出JSON</button>
        <button class="btn ghost" id="resetBtn">清空</button>
      </div>
    </div>
  </header>

  <div class="wrap">
    <aside>
      <h2>角色列表</h2>
      <table class="rolelist">
        <thead><tr><th>角色</th><th>段落数</th></tr></thead>
        <tbody id="roleTbody"></tbody>
      </table>
      <div class="hint">可在右侧表中直接修改角色名，统计会自动刷新。</div>

      <h2 style="margin-top:18px;">别名映射</h2>
      <textarea id="aliasBox" placeholder='示例：{"宁宴":"许七安","小李子":"小李"}'></textarea>
      <div class="hint">用于把外号/称呼统一成同一角色名。</div>

      <h2 style="margin-top:18px;">全局说明</h2>
      <div class="hint">问号300ms，叹号320ms，句号220ms，逗号/顿号160ms；连续旁白自动合并。</div>
    </aside>

    <main>
      <div class="toolbar">
        <span class="pill" id="fileName">未选择文件</span>
        <span class="stat" id="statInfo">—</span>
        <span class="grow"></span>
        <a class="link" href="#" id="exampleLink">导入示例</a>
      </div>
      <table id="scriptTable">
        <thead>
          <tr>
            <th class="rownum">#</th>
            <th class="speaker">角色</th>
            <th class="text">文本</th>
            <th class="cell-ops">参数</th>
          </tr>
        </thead>
        <tbody id="scriptTbody"></tbody>
      </table>
    </main>
  </div>

<script>
/* ===================== 基础常量与状态 ===================== */
const $  = sel => document.querySelector(sel);
const $$ = sel => document.querySelectorAll(sel);

let rawText = "";
let items   = [];   // {speaker, text, style, pause, gain}

const roleColors   = {};
const colorClasses = ["color-a","color-b","color-c","color-d"];
const defaultPauseMap = { "？":300, "?":300, "！":320, "!":320, "。":220, ".":220, "，":160, ",":160, "、":160 };

const NARRATION_VERBS = /(道|说|问|喝道|喃喃|喊|冷哼|揶揄|叹道|应道)/;
const NAME_WHITELIST  = new Set(["旁白","许七安","王捕头","捕快甲","捕快乙","小李"]);
const MAX_NARR_CHARS  = 150;  // 连续旁白合并后的最大字数

/* ===================== 文件与按钮 ===================== */
$("#fileInput").addEventListener("change", async (e)=>{
  const f = e.target.files?.[0];
  if(!f) return;
  $("#fileName").textContent = f.name + `（${Math.round(f.size/1024)} KB）`;
  rawText = await f.text();
  $("#statInfo").textContent = "已载入，点击“自动画本”开始解析。";
});

$("#parseBtn").addEventListener("click", ()=>{
  if(!rawText.trim()){ alert("请先选择文本文件"); return; }
  try{
    const aliasMap = parseAlias($("#aliasBox").value);
    items = parseToScript(rawText, aliasMap);
    renderTable();
    renderRoles();
  }catch(err){
    alert("解析失败：" + err.message);
  }
});

$("#saveJsonBtn").addEventListener("click", ()=>{
  if(!items.length){ alert("无数据"); return; }
  const cast = {};
  items.map(x=>x.speaker.trim()).filter(Boolean).forEach(n=>cast[n]=cast[n]||"");
  const payload = {
    version:"script.v1",
    cast,
    script: items.map(x=>({
      speaker: x.speaker.trim() || "旁白",
      text:    x.text.trim(),
      style:   x.style || undefined,
      pause_ms_after: x.pause || undefined,
      gain_db: x.gain  || undefined
    }))
  };
  const blob = new Blob([JSON.stringify(payload,null,2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "huaben_" + Date.now() + ".json";
  a.click();
});

$("#resetBtn").addEventListener("click", ()=>{
  rawText=""; items=[];
  $("#fileInput").value="";
  $("#fileName").textContent="未选择文件";
  $("#scriptTbody").innerHTML="";
  $("#roleTbody").innerHTML="";
  $("#statInfo").textContent="—";
  $("#aliasBox").value="";
});

$("#exampleLink").addEventListener("click", (e)=>{
  e.preventDefault();
  const demo = `当许七安看到仵作的验尸报告后，又察觉出了一个疑点。
耐着性子继续看，翻看完死者家人和仆人的供词，他闭上眼睛，梳理着思路。
王捕头冷哼一声，揶揄道：“请问许捕快，凶手是何人，在何处？”
许七安：“别急，头儿。”
许七安：“我在卷宗中看到，张宅外墙上留了脚印是吗，你借此推断，贼人翻墙逃走，那小妇人所言不假。”
王捕头：“有什么问题？”
许七安：“脚印是朝外的，所以是逃离时留下的。”
王捕头：“为什么会留下脚印。”
许七安：“因为脚底有泥。”
王捕头：“为什么会有泥。”
许七安：“因为墙边是花圃。”
许七安：“那么，卷宗上为什么没有进入院子的脚印？”
捕快甲：“许是贼人进来时注意到了，没有留下痕迹。”
捕快乙：“但杀人后急于逃脱，匆忙间留下了脚印。”
许七安：“如果贼人能越过花圃不留脚印，这份轻功，那么逃走时不必踏墙借力。”
小李：“或许贼人最初并不想杀人？”
王捕头：“不对！钝器击中后脑，一击毙命，是起了杀心的。”
许七安：“除非凶手当时没有趁手的武器。”
许七安：“还有：张杨氏久跪后昏厥，大夫诊断她怀孕了。”
王捕头：“宁宴，你说清楚……"
许七安：“也许这不是入宅偷盗案，而是偷情杀人案。”`;
  rawText = demo;
  $("#fileName").textContent = "示例文本";
  $("#statInfo").textContent = "已载入示例，点击“自动画本”。";
});

/* ===================== 解析主流程（已修正） ===================== */
function parseToScript(text, alias){
  const lines = blockify(text);
  const out   = [];

  for(const raw of lines){
    const s = raw.trim();

    // 1) 引号台词优先：叙述 + “台词”
    let m = s.match(/^(.*?)([“"])(.+?)([”"])\s*$/);
    if(m){
      const before = m[1].trim();
      const quoted = m[3].trim();
      const spGuess = guessSpeaker(before, alias) || "";

      if(before) out.push(narr(before));                 // 叙述部分做旁白
      if(quoted) splitAndPush(out, spGuess || "路人", quoted); // 引号内容作为台词
      continue;
    }

    // 2) 严格版“人物: 台词”（无引号、无叙述动词）
    m = s.match(/^([^\s:：]{1,8})\s*[:：]\s*(.+)$/);
    if(m){
      const rawName = m[1].trim();
      const after   = m[2].trim();
      const hasQuote = /[“”"]/.test(after);
      const hasVerb  = NARRATION_VERBS.test(s);
      const name     = normalizeSpeaker(rawName, alias);

      if(!hasQuote && !hasVerb && (NAME_WHITELIST.has(name) || name==="旁白" || name.length<=4)){
        splitAndPush(out, name==="旁白" ? "旁白" : name, after);
      }else{
        out.push(narr(s)); // 不满足条件，整体当旁白
      }
      continue;
    }

    // 3) 其它情况 → 旁白
    out.push(narr(s));
  }

  // 情绪与停顿标注
  for(const it of out){
    if(!it.style){
      if(/冷哼|揶揄/.test(it.text)) it.style="taunt";
      else if(/愣住|面面相觑|惊/.test(it.text)) it.style="surprised";
      else if(/沉思|点头|喃喃/.test(it.text)) it.style="calm";
      else it.style="";
    }
    if(!it.pause) it.pause = endPause(it.text);
    it.gain = it.gain ?? 0;
  }

  // 4) 合并连续旁白（关键修正）
  return mergeConsecutiveNarration(out, MAX_NARR_CHARS);
}

/* ===================== 工具函数（含修正） ===================== */
function parseAlias(s){
  if(!s.trim()) return {};
  try{ return JSON.parse(s); } catch{ throw new Error("别名映射不是合法 JSON"); }
}
function blockify(t){
  return t.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
}
function normalizeSpeaker(name, alias){
  name = name.replace(/[“”"『』【】]/g,"").trim();
  if(alias && alias[name]) return alias[name];
  if(name === "宁宴") return "许七安"; // 示例别名
  if(/^捕快/.test(name)) return name; // 捕快甲/乙…
  return name;
}
function guessSpeaker(before, alias){
  // 仅当出现“姓名 + 叙述动词”时才返回说话人
  const m = before.match(/([^\s，。、“”"！？：:]{1,6}).{0,6}?(?:冷哼|揶揄|皱眉|瞪眼|点头|沉思|喃喃|低声|高声)?\s*(?:道|说|问|喝道|喃喃|喊)/);
  if(m) return normalizeSpeaker(m[1], alias);
  return "";
}
function cleanNarr(s){
  return s.replace(/^(?:他|她|众人)心里?想[道]?[：:]?/, "");
}
function endPause(s){
  for(let i=s.length-1;i>=0;i--){
    const ch = s[i];
    if(defaultPauseMap[ch]!=null) return defaultPauseMap[ch];
  }
  return 200;
}
function splitAndPush(out, speaker, content){
  // 只按句号/问号/叹号切，避免把旁白切碎
  const parts = content.split(/([。！？!?])/).reduce((acc, cur, i, arr)=>{
    if(i%2===0){
      const p = (cur + (arr[i+1]||"")).trim();
      if(p) acc.push(p);
    }
    return acc;
  },[]);
  for(const p of parts){
    out.push({speaker: speaker || "路人", text:p, style:"", pause:endPause(p), gain:0});
  }
}
function narr(text){
  return { speaker:"旁白", text: cleanNarr(text), style:"", pause:endPause(text), gain:0 };
}
function mergeConsecutiveNarration(arr, maxChars){
  if(!arr.length) return arr;
  const out = [];
  let buf = null;

  for(const it of arr){
    if(it.speaker === "旁白"){
      if(!buf){ buf = {...it}; }
      else{
        const merged = (buf.text ? buf.text + " " : "") + it.text;
        if(merged.length <= maxChars){
          buf.text  = merged;
          buf.pause = it.pause; // 以最后一条的停顿为段尾停顿
        }else{
          out.push(buf);
          buf = {...it};
        }
      }
    }else{
      if(buf){ out.push(buf); buf = null; }
      out.push(it);
    }
  }
  if(buf) out.push(buf);
  return out;
}

/* ===================== 渲染 ===================== */
function renderTable(){
  const tb = $("#scriptTbody");
  tb.innerHTML = "";

  const roles = [...new Set(items.map(x=>x.speaker))];
  roles.forEach((r, i)=> roleColors[r] = roleColors[r] || colorClasses[i % colorClasses.length]);

  let totalChars = 0;
  items.forEach((it, idx)=>{
    totalChars += it.text.length;
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="rownum">${idx+1}</td>
      <td class="speaker ${ (it.speaker==="旁白" ? "color-narr" : roleColors[it.speaker]||"") }">
        <input type="text" value="${escapeHtml(it.speaker)}" data-i="${idx}" data-k="speaker" />
      </td>
      <td class="text">
        <textarea data-i="${idx}" data-k="text">${escapeHtml(it.text)}</textarea>
        <div class="small">情绪
          <select data-i="${idx}" data-k="style">
            <option value="">默认</option>
            <option value="calm" ${sel(it.style,"calm")}>calm</option>
            <option value="taunt" ${sel(it.style,"taunt")}>taunt</option>
            <option value="surprised" ${sel(it.style,"surprised")}>surprised</option>
            <option value="sad" ${sel(it.style,"sad")}>sad</option>
            <option value="angry" ${sel(it.style,"angry")}>angry</option>
            <option value="whisper" ${sel(it.style,"whisper")}>whisper</option>
          </select>
        </div>
      </td>
      <td class="cell-ops">
        <div class="small">停顿(ms) <input type="number" min="0" step="10" value="${it.pause||200}" data-i="${idx}" data-k="pause" style="width:100px"></div>
        <div class="small" style="margin-top:6px;">增益(dB) <input type="number" step="0.5" value="${it.gain||0}" data-i="${idx}" data-k="gain" style="width:100px"></div>
      </td>
    `;
    tb.appendChild(tr);
  });

  $("#statInfo").textContent = `行数 ${items.length} · 总字数约 ${totalChars}`;

  tb.querySelectorAll("input,textarea,select").forEach(el=>{
    el.addEventListener("input", e=>{
      const i = Number(e.target.getAttribute("data-i"));
      const k = e.target.getAttribute("data-k");
      if(k==="pause" || k==="gain"){ items[i][k] = Number(e.target.value); }
      else { items[i][k] = e.target.value; }
      if(k==="speaker"){ renderRoles(); }
    });
  });
}

function renderRoles(){
  const counts = {};
  items.forEach(x=>{
    const n = x.speaker || "旁白";
    counts[n] = (counts[n]||0) + 1;
  });
  const rows = Object.entries(counts).sort((a,b)=>b[1]-a[1]);
  const tb = $("#roleTbody");
  tb.innerHTML = "";
  rows.forEach(([name, c])=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${name}</td><td>${c}</td>`;
    tb.appendChild(tr);
  });
}

/* ===================== 小工具 ===================== */
function sel(v,k){ return v===k ? "selected" : ""; }
function escapeHtml(s){ return s.replace(/[&<>"]/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;" }[m])); }
</script>
</body>
</html>
